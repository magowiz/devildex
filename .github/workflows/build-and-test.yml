name: Build and Test All Artifacts

on:
  push:
    tags:
      - 'v*.*.*' # This workflow runs when a tag like v1.0.0 is pushed

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install Poetry and Export Plugin
        run: |
          pip install poetry
          poetry self add poetry-plugin-export

      - name: Install system dependencies for wxPython
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libxtst-dev libnotify-dev \
          python3-gi \
          python3-gi-cairo \
          python3-wxgtk4.0 \
          python3-wxgtk-webview4.0

      - name: Install dependencies with pip
        env:
          PIP_FIND_LINKS: "https://extras.wxpython.org/wxPython4/extras/linux/gtk3/ubuntu-24.04/"
        run: |
          poetry lock
          poetry export -f requirements.txt --output requirements.txt --without-hashes
          pip install -r requirements.txt

      - name: Build Linux Wheel
        run: poetry build --format wheel

      - name: Build Linux PyInstaller bundle
        run: poetry run pyinstaller pyinstaller_specs/devildex_linux.spec --distpath dist/linux

      - name: Build Documentation
        run: |
          chmod +x generate_sphinx_doc.sh
          ./generate_sphinx_doc.sh

      - name: Zip documentation
        run: |
          cd build/html
          zip -r devildex_documentation.zip ./*
          mv devildex_documentation.zip ../../dist/
          cd ../..

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: Upload Linux Wheel asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/*.whl
          asset_name: devildex-linux-wheel-${{ github.ref_name }}.whl
          asset_content_type: application/zip

      - name: Upload Linux PyInstaller bundle asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/linux/devildex
          asset_name: devildex-linux-bundle-${{ github.ref_name }}.zip
          asset_content_type: application/zip

      - name: Upload Documentation asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/devildex_documentation.zip
          asset_name: devildex-documentation-${{ github.ref_name }}.zip
          asset_content_type: application/zip