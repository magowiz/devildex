name: Test Packaged Application

on:
  workflow_run:
    workflows: ["Package Desktop Application"]
    types:
      - completed

jobs:
  test-windows-package:
    runs-on: windows-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: devildex-windows-latest-build
          path: build/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}

      - name: List downloaded files (Windows)
        run: ls -R build/

      - name: Test Built Application (Windows)
        run: |
          Start-Process -FilePath ".\build\devildex_windows\devildex_windows.exe" -NoNewWindow -PassThru | Wait-Process -Timeout 20
          Stop-Process -Name "devildex_windows.exe" -ErrorAction SilentlyContinue

  test-macos-package:
    runs-on: macos-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: devildex-macos-latest-build
          path: build/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}

      - name: List downloaded files (macOS)
        run: ls -R build/

      - name: Test Built Application (macOS)
        run: |
          chmod +x ./build/devildex_macos
          ./build/devildex_macos &
          sleep 20
          kill %1

  test-linux-package:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: devildex-ubuntu-latest-build
          path: build/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}

      - name: List downloaded files (Linux)
        run: ls -R build/

      - name: Test Built Application (Linux)
        run: |
          chmod +x ./build/devildex_linux
          ./build/devildex_linux &
          sleep 20
          kill %1
